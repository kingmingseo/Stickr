# ê²€ìƒ‰ ê²°ê³¼ ì¤‘ë³µ í‚¤ ì´ìŠˆ í•´ê²°

> **íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ë¬¸ì„œ**  
> í”„ë¡œì íŠ¸: Stickr  
> ì‘ì„±ì¼: 20251031

<br/>

## ğŸ“‹ ëª©ì°¨
- [ë¬¸ì œ ì •ì˜](#-ë¬¸ì œ-ì •ì˜)
- [ë°œìƒ í™˜ê²½](#-ë°œìƒ-í™˜ê²½)
- [ì›ì¸ ë¶„ì„](#-ì›ì¸-ë¶„ì„)
- [í•´ê²° ë°©ë²•](#-í•´ê²°-ë°©ë²•)
- [êµ¬í˜„ ìƒì„¸](#-êµ¬í˜„-ìƒì„¸)
- [ê²°ê³¼ ë° ê²€ì¦](#-ê²°ê³¼-ë°-ê²€ì¦)
- [êµí›ˆ ë° ê°œì„ ì‚¬í•­](#-êµí›ˆ-ë°-ê°œì„ ì‚¬í•­)

<br/>

## ğŸ”´ ë¬¸ì œ ì •ì˜

### ì¦ìƒ
ê²€ìƒ‰ í™”ë©´ì—ì„œ ë¬´í•œ ìŠ¤í¬ë¡¤ ì‚¬ìš© ì‹œ **FlatListì—ì„œ ì¤‘ë³µ í‚¤ ê²½ê³ **ê°€ ë°œìƒí•˜ê³ , **ê°™ì€ ìŠ¤í‹°ì»¤ê°€ ì—¬ëŸ¬ ë²ˆ í‘œì‹œ**ë¨

### ì—ëŸ¬ ë©”ì‹œì§€

```
console.js:661 Encountered two children with the same key, 
`.$326d7445-631d-4a14-a7a3-0a5cb098b01e=28c19fafe-cf8d-4e7d-bb58-af11e1c6c6d6=25905f6b1-cde6-4aee-bd39-90c4884efd43`. 
Keys should be unique so that components maintain their identity across updates.
```

### êµ¬ì²´ì ì¸ ë¬¸ì œ ìƒí™©

1. **ì¤‘ë³µ ë°ì´í„° í‘œì‹œ**
   - ì²« í˜ì´ì§€ì™€ ë‘ ë²ˆì§¸ í˜ì´ì§€ì— ê°™ì€ ìŠ¤í‹°ì»¤ê°€ ë‚˜íƒ€ë‚¨
   - ì‚¬ìš©ìê°€ ë™ì¼í•œ ìŠ¤í‹°ì»¤ë¥¼ ì—¬ëŸ¬ ë²ˆ ë´„
   - FlatList ë Œë”ë§ ì„±ëŠ¥ ì €í•˜

2. **React ê²½ê³  ë°œìƒ**
   - `keyExtractor`ì—ì„œ ì¤‘ë³µ í‚¤ ê°ì§€
   - ê°œë°œ ëª¨ë“œì—ì„œ ë¹¨ê°„ ê²½ê³  í™”ë©´ í‘œì‹œ

3. **íŠ¹ì • í™”ë©´ì—ë§Œ ë°œìƒ**
   - **ê²€ìƒ‰ í™”ë©´**: ì¤‘ë³µ ë°œìƒ âŒ
   - í™ˆ í™”ë©´: ì •ìƒ ì‘ë™ âœ…
   - ì¦ê²¨ì°¾ê¸° í™”ë©´: ì •ìƒ ì‘ë™ âœ…

<br/>

## ğŸŒ ë°œìƒ í™˜ê²½

### ê¸°ìˆ  ìŠ¤íƒ
- **í”Œë«í¼**: React Native 0.81.4
- **ë°ì´í„°ë² ì´ìŠ¤**: Supabase (PostgreSQL)
- **ì£¼ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬**:
  - `@tanstack/react-query`: ë°ì´í„° íŒ¨ì¹­ ë° ìºì‹±
  - React Native `FlatList`: ëª©ë¡ ë Œë”ë§

### ë°ì´í„° êµ¬ì¡°
```typescript
interface Sticker {
  id: string;                    // UUID (ê³ ìœ  í‚¤)
  auto_increment_id: number;     // ìë™ ì¦ê°€ ID
  like_count: number;            // ì¢‹ì•„ìš” ìˆ˜
  title: string;
  image_url: string;
  // ... ê¸°íƒ€ í•„ë“œ
}
```

### í˜ì´ì§€ë„¤ì´ì…˜ ë°©ì‹
- **Cursor ê¸°ë°˜**: `like_count|auto_increment_id` í˜•ì‹
- **ë¬´í•œ ìŠ¤í¬ë¡¤**: React Queryì˜ `useInfiniteQuery`
- **ì •ë ¬**: `like_count DESC, auto_increment_id DESC`

<br/>

## ğŸ” ì›ì¸ ë¶„ì„

### ê·¼ë³¸ ì›ì¸: ORDER BY ëˆ„ë½

#### ë¬¸ì œ ì½”ë“œ (ìˆ˜ì • ì „)

```typescript
// ë¬¸ì œê°€ ìˆë˜ ì½”ë“œ (src/api/sticker.ts - searchStickers)
export const searchStickers = async ({ 
  searchText, 
  limit = 20, 
  cursor 
}: SearchStickersParams) => {
  let supabaseQuery = supabase
    .from('sticker')
    .select('*, user_favorites(user_id)')
    .or(orFilter)
    .limit(limit);
    // ORDER BYê°€ ì—†ìŒ

  if (cursor) {
    supabaseQuery = supabaseQuery.or(
      `like_count.lt.${likeCursor},and(like_count.eq.${likeCursor},auto_increment_id.lt.${idCursor})`
    );
  }

  const { data, error } = await supabaseQuery;
  // ...
};
```

### ì™œ ì¤‘ë³µì´ ë°œìƒí–ˆëŠ”ê°€?

#### 1. PostgreSQLì˜ ì •ë ¬ ì—†ëŠ” ì¿¼ë¦¬

**ì •ë ¬ì´ ì—†ìœ¼ë©´** ë°ì´í„°ë² ì´ìŠ¤ëŠ” **ì„ì˜ì˜ ìˆœì„œ**ë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```sql
-- ì •ë ¬ ì—†ìŒ
SELECT * FROM sticker WHERE ... LIMIT 20;
-- ê²°ê³¼: [ID:50, ID:35, ID:80, ID:42, ...] (ë¬´ì‘ìœ„ ìˆœì„œ)
```

ì´ ìˆœì„œëŠ”:
- ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥
- ì‹¤í–‰ë§ˆë‹¤ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŒ
- ë‚´ë¶€ ì €ì¥ ìˆœì„œì— ì˜ì¡´

#### 2. Cursor í˜ì´ì§€ë„¤ì´ì…˜ì´ ê¹¨ì§

``` 
[ì˜ˆì‹œ í˜ì´ì§€ 1 ìš”ì²­]
ì¿¼ë¦¬: WHERE ê²€ìƒ‰ì¡°ê±´ LIMIT 20
ê²°ê³¼: [ID:50, ID:35, ID:80, ID:42, ...]
      like_count: [15,  12,  10,  10, ...]
ë§ˆì§€ë§‰ í•­ëª©: like_count=10, id=42
â†’ nextCursor = "10|42"

[ì˜ˆì‹œ í˜ì´ì§€ 2 ìš”ì²­] (cursor="10|42")
ì¿¼ë¦¬: WHERE ê²€ìƒ‰ì¡°ê±´ 
      AND (like_count < 10 OR (like_count = 10 AND id < 42))
      LIMIT 20
ê²°ê³¼: [ID:35, ID:25, ID:50, ...]
      â†‘ ID:35ì™€ ID:50ì€ ì´ë¯¸ í˜ì´ì§€ 1ì— ìˆì—ˆìŒ!
```

**ë¬¸ì œ**:
- Cursor ì¡°ê±´ì€ `like_count < 10 OR ...`
- í•˜ì§€ë§Œ ì •ë ¬ì´ ì—†ì–´ì„œ `like_count=12`ì¸ ID:35ê°€ í˜ì´ì§€ 2ì— ë‹¤ì‹œ ë‚˜íƒ€ë‚¨
- í˜ì´ì§€ 1ì—ì„œ ë¬´ì‘ìœ„ ìˆœì„œë¡œ ë‚˜ì™”ë˜ ë°ì´í„°ê°€ í˜ì´ì§€ 2ì— ë‹¤ì‹œ ë“±ì¥

#### 3. flatMapìœ¼ë¡œ í•©ì¹  ë•Œ ì¤‘ë³µ ë°œìƒ

```typescript
// React Queryì˜ useInfiniteQuery
const stickers = data.pages.flatMap(page => page.data);
// [ID:50, ID:35, ..., ID:35, ID:50, ...]
// ì¤‘ë³µ ë°œìƒ
```

FlatListì˜ `keyExtractor`:
```typescript
<FlatList
  data={stickers}
  keyExtractor={item => item.id} // ID:35ê°€ 2ë²ˆ ë‚˜íƒ€ë‚¨, ì¤‘ë³µ í‚¤ ê²½ê³ 
/>
```

<br/>

## âœ… í•´ê²° ë°©ë²•

### í•µì‹¬ í•´ê²°ì±…: ORDER BY ì¶”ê°€

```typescript
// ìˆ˜ì •ëœ ì½”ë“œ
let supabaseQuery = supabase
  .from('sticker')
  .select('*, user_favorites(user_id)')
  .or(orFilter)
  .order('like_count', { ascending: false })        // ì¢‹ì•„ìš” ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
  .order('auto_increment_id', { ascending: false }) // ë™ì¼ ì¢‹ì•„ìš” ì‹œ ìµœì‹  ìš°ì„ 
  .limit(limit);

if (cursor) {
  const [likeStr, idStr] = cursor.split('|');
  const likeCursor = parseInt(likeStr);
  const idCursor = parseInt(idStr);
  
  supabaseQuery = supabaseQuery.or(
    `like_count.lt.${likeCursor},and(like_count.eq.${likeCursor},auto_increment_id.lt.${idCursor})`
  );
}
```

### ì™œ ì´ì œ ì‘ë™í•˜ëŠ”ê°€?

1. **ì¼ê´€ëœ ìˆœì„œ ë³´ì¥**
   - í•­ìƒ `like_count DESC, auto_increment_id DESC` ìˆœì„œë¡œ ë°˜í™˜
   - ì‹¤í–‰ë§ˆë‹¤ ë™ì¼í•œ ê²°ê³¼ ë³´ì¥

2. **Cursor ì¡°ê±´ê³¼ ì¼ì¹˜**
   - CursorëŠ” `like_count < X OR (like_count = X AND id < Y)`
   - ì •ë ¬ ìˆœì„œì™€ ì •í™•íˆ ì¼ì¹˜

3. **í˜ì´ì§€ ê²½ê³„ ëª…í™•**
   - ê° í˜ì´ì§€ì˜ ë§ˆì§€ë§‰ í•­ëª©ì´ ëª…í™•í•œ ê¸°ì¤€ì 
   - ë‹¤ìŒ í˜ì´ì§€ëŠ” ì •í™•íˆ ê·¸ ë‹¤ìŒë¶€í„° ì‹œì‘

<br/>

## ğŸ›  êµ¬í˜„ ìƒì„¸

### 1. ìˆ˜ì •ëœ API í•¨ìˆ˜

#### íŒŒì¼: `src/api/sticker.ts`

```typescript
export const searchStickers = async ({
  searchText,
  limit = 20,
  cursor,
  userId,
}: SearchStickersParams): Promise<StickersResponse> => {
  // ê²€ìƒ‰ ì¡°ê±´ ìƒì„±
  const orFilter = `title.ilike.%${searchText}%,tags.cs.{${searchText}}`;

  // ê¸°ë³¸ ì¿¼ë¦¬ (ORDER BY í¬í•¨!)
  let supabaseQuery = supabase
    .from('sticker')
    .select('*, user_favorites(user_id)')
    .or(orFilter)
    .order('like_count', { ascending: false })
    .order('auto_increment_id', { ascending: false });

  // Cursor í˜ì´ì§€ë„¤ì´ì…˜
  if (cursor) {
    const [likeStr, idStr] = cursor.split('|');
    const likeCursor = parseInt(likeStr, 10);
    const idCursor = parseInt(idStr, 10);

    // like_count < X OR (like_count = X AND auto_increment_id < Y)
    supabaseQuery = supabaseQuery.or(
      `like_count.lt.${likeCursor},and(like_count.eq.${likeCursor},auto_increment_id.lt.${idCursor})`
    );
  }

  // limitì€ ë§ˆì§€ë§‰ì—!
  supabaseQuery = supabaseQuery.limit(limit);

  const { data, error } = await supabaseQuery;

  if (error) {
    throw new Error(`ê²€ìƒ‰ ì‹¤íŒ¨: ${error.message}`);
  }

  // ìŠ¤í‹°ì»¤ ë°ì´í„° ë§¤í•‘
  const stickers: Sticker[] = (data || []).map(item => ({
    ...item,
    isFavorite: userId
      ? item.user_favorites?.some((fav: any) => fav.user_id === userId)
      : false,
  }));

  // ë‹¤ìŒ ì»¤ì„œ ìƒì„±
  let nextCursor: string | null = null;
  if (stickers.length === limit) {
    const lastSticker = stickers[stickers.length - 1];
    nextCursor = `${lastSticker.like_count}|${lastSticker.auto_increment_id}`;
  }

  return { data: stickers, nextCursor };
};
```

### 2. Supabase ì¿¼ë¦¬ ì²´ì´ë‹ ìˆœì„œ

**ì˜¬ë°”ë¥¸ ìˆœì„œ** (ì¤‘ìš”!):
```typescript
supabase
  .from('table')
  .select('*')           // 1. í•„ë“œ ì„ íƒ
  .or(ê²€ìƒ‰ì¡°ê±´)           // 2. WHERE ì¡°ê±´
  .order('field1')       // 3. ì •ë ¬ (í•„ìˆ˜!)
  .order('field2')       // 4. ë³´ì¡° ì •ë ¬
  .or(cursorì¡°ê±´)         // 5. í˜ì´ì§€ë„¤ì´ì…˜ ì¡°ê±´
  .limit(N)              // 6. ê°œìˆ˜ ì œí•œ
```

### 3. React Query í›…

#### íŒŒì¼: `src/hooks/query/useSearchStickers.ts`

```typescript
export const useSearchStickers = (searchText: string) => {
  const { userId } = useAuth();

  return useInfiniteQuery({
    queryKey: ['searchStickers', searchText, userId],
    queryFn: ({ pageParam }) =>
      searchStickers({
        searchText,
        cursor: pageParam,
        userId,
      }),
    initialPageParam: undefined,
    getNextPageParam: (lastPage) => lastPage.nextCursor,
    enabled: searchText.length > 0,
    staleTime: 1000 * 60 * 5,  // 5ë¶„
    gcTime: 1000 * 60 * 10,    // 10ë¶„
  });
};
```

### 4. í™”ë©´ì—ì„œ ì‚¬ìš©

#### íŒŒì¼: `src/screens/search/SearchScreen.tsx`

```tsx
const SearchScreen = () => {
  const [activeQuery, setActiveQuery] = useState('');
  
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage,
  } = useSearchStickers(activeQuery);

  // ëª¨ë“  í˜ì´ì§€ì˜ ë°ì´í„°ë¥¼ í‰íƒ„í™”
  const stickers = data?.pages.flatMap(page => page.data) ?? [];

  return (
    <FlatList
      data={stickers}
      keyExtractor={(item, index) => `${item.id}-${index}`} // ì¸ë±ìŠ¤ ì¶”ê°€ë¡œ ì™„ì „ ê³ ìœ  ë³´ì¥
      renderItem={({ item }) => <StickerCard sticker={item} />}
      onEndReached={() => {
        if (hasNextPage && !isFetchingNextPage) {
          fetchNextPage();
        }
      }}
    />
  );
};
```

### 5. ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€

```typescript
// ê°œë°œ ëª¨ë“œì—ì„œ ì¤‘ë³µ í™•ì¸
if (__DEV__) {
  const ids = stickers.map(s => s.id);
  const uniqueIds = new Set(ids);
  
  if (ids.length !== uniqueIds.size) {
    console.warn('âš ï¸ ì¤‘ë³µ ID ë°œê²¬!', {
      total: ids.length,
      unique: uniqueIds.size,
      duplicates: ids.filter((id, index) => ids.indexOf(id) !== index),
    });
  } else {
    console.log('âœ… ì¤‘ë³µ ì—†ìŒ', {
      total: ids.length,
    });
  }
}
```

<br/>

## ğŸ“Š ê²°ê³¼ ë° ê²€ì¦

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì¼ë°˜ ê²€ìƒ‰

```
1. "ê³ ì–‘ì´" ê²€ìƒ‰
2. ì²« í˜ì´ì§€ ë¡œë“œ (20ê°œ ìŠ¤í‹°ì»¤)
3. ìŠ¤í¬ë¡¤í•˜ì—¬ ë‘ ë²ˆì§¸ í˜ì´ì§€ ë¡œë“œ
4. ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ

ë””ë²„ê·¸ ë¡œê·¸:
ì¤‘ë³µ ì—†ìŒ { total: 40 }
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ë™ì¼ like_count ì¼€ì´ìŠ¤

```
ë°ì´í„°:
- ID:50, like_count:10, auto_increment_id:50
- ID:49, like_count:10, auto_increment_id:49
- ID:48, like_count:10, auto_increment_id:48

ì²« í˜ì´ì§€: [50, 49, 48, ...]
ë‘ ë²ˆì§¸ í˜ì´ì§€: [47, 46, ...]
ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ
```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ë¹ ë¥¸ ì—°ì† ìŠ¤í¬ë¡¤

```
1. "ìŠ¤í‹°ì»¤" ê²€ìƒ‰
2. ë¹ ë¥´ê²Œ ìŠ¤í¬ë¡¤í•˜ì—¬ 5í˜ì´ì§€ê¹Œì§€ ë¡œë“œ
3. ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ

ë””ë²„ê·¸ ë¡œê·¸:
ì¤‘ë³µ ì—†ìŒ { total: 100 }
```

### ë¹„êµ: ë‹¤ë¥¸ í™”ë©´ë“¤

#### í™ˆ í™”ë©´ (`getRecentStickers`)
```typescript
// ORDER BY ìˆìŒ (ì²˜ìŒë¶€í„°)
.order('auto_increment_id', { ascending: false })
```
ë¬¸ì œ ì—†ì—ˆìŒ

#### ì¦ê²¨ì°¾ê¸° í™”ë©´ (`getMyFavorites`)
```typescript
// ORDER BY ìˆìŒ (ì²˜ìŒë¶€í„°)
.order('created_at', { ascending: false })
.order('sticker_id', { ascending: false })
```
ë¬¸ì œ ì—†ì—ˆìŒ

#### ê²€ìƒ‰ í™”ë©´ (`searchStickers`)
```typescript
// ORDER BY ì—†ìŒ (ìˆ˜ì • ì „)
```
ë¬¸ì œ ë°œìƒ!

**ê²°ë¡ **: ê²€ìƒ‰ APIì—ë§Œ ORDER BYê°€ ëˆ„ë½ë˜ì–´ ìˆì—ˆìŒ

<br/>

## ğŸ“ êµí›ˆ ë° ê°œì„ ì‚¬í•­

### í•µì‹¬ êµí›ˆ

1. **Cursor í˜ì´ì§€ë„¤ì´ì…˜ì˜ ê¸°ë³¸ ì›ì¹™**
   ```
   í˜ì´ì§€ë„¤ì´ì…˜ = ì •ë ¬ + ì œí•œ + Cursor
   ì •ë ¬ì´ ì—†ìœ¼ë©´ Cursorê°€ ë¬´ì˜ë¯¸í•¨
   ```

2. **PostgreSQLì˜ íŠ¹ì„±**
   - ORDER BY ì—†ì´ ì¿¼ë¦¬í•˜ë©´ ìˆœì„œê°€ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥
   - ë‚´ë¶€ ì €ì¥ ìˆœì„œëŠ” ë³€ê²½ë  ìˆ˜ ìˆìŒ
   - í•­ìƒ ëª…ì‹œì ìœ¼ë¡œ ì •ë ¬í•´ì•¼ í•¨

3. **ì¼ê´€ì„±ì˜ ì¤‘ìš”ì„±**
   - ë‹¤ë¥¸ APIë“¤ì€ ì •ë ¬ì´ ìˆì—ˆìŒ
   - ê²€ìƒ‰ APIë§Œ ì˜ˆì™¸ì ìœ¼ë¡œ ëˆ„ë½
   - ì½”ë“œ í…œí”Œë¦¿ì´ë‚˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ í•„ìš”

4. **ë””ë²„ê¹… ë¡œê·¸ì˜ ê°€ì¹˜**
   - ì¤‘ë³µ í™•ì¸ ë¡œê·¸ê°€ ë¬¸ì œ íŒŒì•…ì— ê²°ì •ì  ë„ì›€
   - ê°œë°œ ëª¨ë“œì—ì„œ ìë™ìœ¼ë¡œ ê²€ì¦í•˜ëŠ” ê²ƒì´ ì¤‘ìš”




### ê´€ë ¨ ë¬¸ì„œ

- [Supabase Pagination](https://supabase.com/docs/guides/api/pagination)
- [PostgreSQL ORDER BY](https://www.postgresql.org/docs/current/queries-order.html)
- [React Query Infinite Queries](https://tanstack.com/query/latest/docs/framework/react/guides/infinite-queries)

<br/>

---

<div align="center">

**âœ… í•´ê²° ì™„ë£Œ**  
ê²€ìƒ‰ ì‹œ ì¤‘ë³µ í‚¤ ì—ëŸ¬ ë° ì¤‘ë³µ ë°ì´í„° í‘œì‹œ ì™„ì „ í•´ê²°

**í•´ê²° ì¼ì‹œ**: 2024.10.17  
**ìµœì¢… ìˆ˜ì •**: `src/api/sticker.ts` - `searchStickers()` í•¨ìˆ˜

</div>
